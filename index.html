<html>
    <head>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <style>
            div.tooltip {
                position: absolute;
                text-align: center;
                width: 85px;
                height: 28px;
                padding: 2px;
                font: 12px sans-serif;
                background: white;
                border: 0px;
                border-radius: 8px;
                pointer-events: none;       
            }

            .flex-container {
                display: flex;
            }

            .flex-child {
                flex: 1;
            }  

            .flex-child:first-child {
                margin-right: 2px;
            } 

            p {
                font-family:'Segoe UI', Geneva;
            }

            p:first-child {
                margin-top: 50px;
            }

            button {
                margin-top: 1px;
            }
        </style>
    </head>

    <body>
        <div class="flex-container">
            <div id="visualization" class="flex-child">
            
            </div>
            <div id="options" class="flex-child">
                <p>sort data in descending order</p>
                <button id="sort">sort</button>
                <p>unsort data to original order</p>
                <button id="unsort">unsort</button>
                <br>
                <br>
                <p>select year</p>
                <select id="selectYear">
                    <option>all</option>
                    <option>2010</option>
                    <option>2011</option>
                    <option>2012</option>
                    <option>2013</option>
                    <option>2014</option>
                    <option>2015</option>
                    <option>2016</option>
                    <option>2017</option>
                    <option>2018</option>
                    <option>2019</option>
                </select>
            </div>
        </div>

        <script>
            console.log(d3); // test if d3 is loaded
            var margin = {top: 50, left: 100, bottom: 80, right: 50};
            var width = 1325 - margin.left - margin.right; 
            var height = 1500 - margin.top - margin.bottom;

            const svg = d3.select("div#visualization")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform","translate(" + margin.left + "," + margin.top + ")");

            svg.append("rect")
                .attr("x",0)
                .attr("y",0)
                .attr("height", height)
                .attr("width", width)
                .style("fill", "tan")

            var div = d3.select("div#visualization").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            let data = d3.csv("data/Tricorache et al_Global trade dataset for cheetah.csv", d3.autoType).then(function(data) {
                const grouped_data = d3.rollups(data, v => d3.sum(v, d => d.Cheetahs), d => d.Country);
                const grouped_data_year = d3.rollups(data, v => d3.sum(v, d => d.Cheetahs), d => d.Country, d => d.Year);

                const filtered_grouped_data = grouped_data.filter(function (d) {
                    return d[1] > 0;
                })

                var current_data = [...filtered_grouped_data];

                // x axis
                var xScale = d3.scaleLinear()
                    .domain([0, 1700])
                    .range([0, width]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .attr("font-family", 'Segoe UI')
                    .style("text-anchor", "end");
                svg.append("g")
                    .attr("transform", "translate(0," + 0 + ")")
                    .call(d3.axisTop(xScale))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(45)")
                    .attr("font-family", 'Segoe UI')
                    .style("text-anchor", "end");


                // y axis
                var yScale = d3.scaleBand()
                    .range([ 0, height ])
                    .domain(current_data.map(function(d) {return d[0];}))
                    .padding(.1);
                svg.append("g")
                    .call(d3.axisLeft(yScale))
                    .attr('class', 'y-axis')
                    .attr("font-family", 'Segoe UI')

                var axisLeft = d3.axisLeft(yScale).tickFormat(function(d) {return d; });

                // bars
                svg.selectAll("myRect")
                    .data(filtered_grouped_data)
                    .enter()
                    .append("rect")
                    .attr("class","bar")
                    .attr("x", xScale(0) )
                    .attr("y", function(d) { return yScale(d[0]); })
                    .attr("width", function(d) { return xScale(d[1]); })
                    .attr("height", yScale.bandwidth() )
                    .attr("fill", "brown")
                    .on("mouseover", function(event,d) {
                        //console.log(d);
                        div.transition()
                            .duration(200)
                            .style("opacity", 1);
                        div.html("# of cheetahs: " + d[1] + "<br/>")
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                    .on("mouseout", function(d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                        });

                // x axis label:
                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("x", width/2 + margin.left)
                    .attr("y", height + margin.top + 10)
                    .attr("font-family", 'Segoe UI')
                    .text("# of cheetahs");

                // y axis label:
                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -margin.top - height/2 + 20)
                    .attr("font-family", 'Segoe UI')
                    .text("country")

                d3.selectAll(".y-axis text")
                    .attr("class", "bar-label"); 

                d3.select("#sort").on("click", function() {
                    copied_current_data = [...current_data];
                    sorted_data = copied_current_data.sort(function(a, b) {
                        return a[1] - b[1];
                    }).reverse();
                            
                        yScale.domain(sorted_data.map(function(d) {
                            //console.log(d);
                            return d[0];
                        })); 
                            
                        // move bars
                            svg.selectAll(".bar")
                                .transition()
                                .duration(500)
                                .attr("y", function(d, i) {
                                    return yScale(d[0]);
                                });
                            
                        // move labels
                            svg.select('g.y-axis')
                                .transition()
                                        .duration(500)
                                .call(axisLeft);	    
                            
                        });

                d3.select("#unsort").on("click", function() {
                    yScale.domain(current_data.map(function(d) {
                            return d[0];
                        })); 

                        // move bars
                            svg.selectAll(".bar")
                                .transition()
                                .duration(500)
                                .attr("y", function(d, i) {
                                    return yScale(d[0]);
                                });
                            
                        // move labels
                            svg.select('g.y-axis')
                                .transition()
                                        .duration(500)
                                .call(axisLeft);	    
                        });

                        d3.select("#selectYear").on("change", changeYear)

                        function changeYear() {
                            var selectedYear = this.options[this.selectedIndex].value;
                            //console.log(selectedYear);

                            if (selectedYear == "all") {
                                current_data = [...filtered_grouped_data];
                                // move bars
                                svg.selectAll(".bar")
                                        .data(current_data)
                                        .transition()
                                        .duration(500)
                                        .attr("width", function(d) { return xScale(d[1]);});
                            }

                            else {
                                const copied_year_data = [...grouped_data_year];
                                var new_data = copied_year_data.map(function(d) {
                                    var num = 0;
                                    for(var i=0; i<d[1].length; i++) {
                                        if (d[1][i][0] == selectedYear) {
                                            num = d[1][i][1];
                                        }
                                    }
                                    return [d[0], num];
                                }); 

                                filtered_new_data = new_data.filter(function(d) {
                                    return d[1] > 0;
                                });
                                
                                current_data = [...new_data];

                                // move bars
                                svg.selectAll(".bar")
                                        .data(new_data)
                                        .transition()
                                        .duration(500)
                                        .attr("width", function(d) { return xScale(d[1]);});
                            }
                        }
                
        
            });
        
        </script>
    </body>
</html>