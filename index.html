<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" charset="utf-8"></script>
    <style type="text/css">
       body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center; 
        }

        #searchInput {
          padding: 10px;
          width: 300px;
          font-size: 16px;
        }
        #suggestions {
          display: none;
          position: absolute;
          width: 300px;
          background-color: white;
          border: 1px solid #ccc;
          z-index: 999; /* Ensure it's above other content */
        }
        .suggestion {
          padding: 5px;
          cursor: pointer;
        }
        .suggestion:hover {
          background-color: #f0f0f0;
        }
    </style>
</head>
<body>

<div class="container">
  <div class="box" id="searchBar">
      <input type="text" id="searchInput" placeholder="Search...">
      <div id="suggestions"></div>
  </div>

  <div class="box" id="chartPlaceholder"></div>
</div>

<script type="text/javascript">
    const listOfGuns = [
      "AK-12",
      "AK-101",
      "AK-102",
      "AK-103",
      "AK-104",
      "AK-105",
      "AK-74",
      "AK-74M",
      "AK-74N",
      "AKM",
      "AKMN",
      "AKMS",
      "AKMSN",
      "AKS-74",
      "AKS-74N",
      "AKS-74U",
      "AKS-74UB",
      "AKS-74UN",
      "AS VAL",
      "ASh-12",
      "AUG A1",
      "AUG A3",
      "DT MDR 5.56x45",
      "DT MDR 7.62x51",
      "HK 416A5",
      "HK G36",
      "M4A1",
      "MCX",
      "MCX SPEAR",
      "Mk47",
      "RD-704",
      "SA-58",
      "SCAR-H",
      "SCAR-L",
      "9A-91",
      "ADAR 2-15",
      "AVT-40",
      "OP-SKS",
      "RFB",
      "SAG AK",
      "SAG AK Short",
      "SKS",
      "SVT-40",
      "TX-15 DML",
      "VPO-101",
      "VPO-136",
      "VPO-209",
      "VSK-94",
      "PKM",
      "PKP",
      "RPD",
      "RPDN",
      "RPK-16",
      "MP5",
      "MP5K-N",
      "MP7A1",
      "MP7A2",
      "MP9",
      "MP9-N",
      "MPX",
      "P90",
      "PP-19-01 Vityaz-SN",
      "PP-9 \"Klin\"",
      "PP-91 \"Kedr\"",
      "PP-91-01 \"Kedr-B\"",
      "PPSh-41",
      "Saiga-9",
      "SR-2M",
      "STM-9",
      "UMP 45",
      "Vector .45",
      "Vector 9x19",
      "KS-23M",
      "M3 Super 90",
      "M590A1",
      "M870",
      "MP-18",
      "MP-133",
      "MP-153",
      "MP-155",
      "MP-43-1C",
      "MTs-255-12",
      "Saiga-12K",
      "TOZ-106",
      "HK G28",
      "M1A",
      "Mk-18",
      "RSASS",
      "SR-25",
      "SVDS",
      "VSS Vintorez",
      "AXMC",
      "DVL-10",
      "M700",
      "Mosin (Infantry)",
      "Mosin (Sniper)",
      "SV-98",
      "T-5000",
      "VPO-215",
      "FN40GL",
      "M32A1",
      "APB",
      "APS",
      "FN 5-7",
      "Glock 17",
      "Glock 18C",
      "Glock 19X",
      "M1911A1",
      "M45A1",
      "M9A3",
      "MP-443 \"Grach\"",
      "P226R",
      "PB pistol",
      "PL-15",
      "PM (t) pistol",
      "PM pistol",
      "SR-1MP Gyurza",
      "TT pistol",
      "TT pistol (gold)",
      "USP .45",
      "CR 200DS",
      "CR 50DS",
      "RSh-12"
    ];

    const listOfCalibers = [
      "7.62x25mm Tokarev",
      "9x18mm Makarov",
      "9x19mm Parabellum",
      "9x21mm Gyurza",
      ".357 Magnum",
      ".45 ACP",
      "4.6x30mm HK",
      "5.7x28mm FN",
      "5.45x39mm",
      "5.56x45mm NATO",
      "6.8x51mm",
      ".300 Blackout",
      "7.62x39mm",
      "7.62x51mm NATO",
      "7.62x54mmR",
      ".338 Lapua Magnum",
      "9x39mm",
      ".366 TKM",
      "12.7x55mm STs-130",
      "12/70",
      "20/70"
    ];

    let selectedGun = ''

    const searchInput = document.getElementById("searchInput");
    const suggestions = document.getElementById("suggestions");

    function updateSuggestions() {
      const inputValue = searchInput.value.trim().toLowerCase().replace(/[-.'()""\s]/g, '');
      if (inputValue === '') {
        suggestions.style.display = 'none';
        return;
      }
      
      const filteredWords = [...listOfCalibers, ...listOfGuns].filter(word => {
        const sanitizedWord = word.toLowerCase().replace(/[-.'()""\s]/g, '');
        return sanitizedWord.includes(inputValue);
      });

      const suggestionHTML = filteredWords.map(word => {
        return `<div class="suggestion">${word}</div>`;
      }).join('');
      suggestions.innerHTML = suggestionHTML;
      suggestions.style.display = 'block';
      
      const inputRect = searchInput.getBoundingClientRect();
      suggestions.style.top = `${inputRect.bottom + window.scrollY}px`;
      suggestions.style.left = `${inputRect.left + window.scrollX}px`;

      const suggestionElements = document.querySelectorAll('.suggestion');
      suggestionElements.forEach(suggestion => {
        suggestion.addEventListener('click', () => {
          searchInput.value = suggestion.innerText;
          selectedGun = suggestion.innerText;
          generateChart();
          suggestions.style.display = 'none';
          searchInput.blur();
        });
      });
    }

    searchInput.addEventListener("input", updateSuggestions);

    searchInput.addEventListener("keydown", function(event) {
      if (event.key === 'Enter') {
        const firstSuggestion = suggestions.querySelector('.suggestion');
        if (firstSuggestion) {
          searchInput.value = firstSuggestion.innerText;
          selectedGun = firstSuggestion.innerText;
          generateChart();
          suggestions.style.display = 'none';
          searchInput.blur();
        }
      }
    });

    searchInput.addEventListener("focus", function() {
      searchInput.value = '';
    });

    const margin = { top: 20, right: 20, bottom: 50, left: 50 };
    const width = 600 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;
    
    //d3.select('#chartPlaceholder').selectAll('*').remove();

    function generateChart() {
      d3.select('#chartPlaceholder').selectAll('*').remove();
      
      var svg = d3.select('#chartPlaceholder')
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      d3.csv("TarkovAmmo.csv").then(data => {
        let filteredData = data.filter(d => 
            d['Guns'].includes(selectedGun) || 
            d['Caliber'].includes(selectedGun)
        );

        filteredData.forEach(d => {
          d['DMG'] = parseDamage(d['DMG']);
          d['Penetration Power'] = +d['Penetration Power'];
        });

        function parseDamage(damageString) {
          if (damageString.includes('x')) {
            const parts = damageString.split('x').map(Number);
            return parts.reduce((total, part) => total * part, 1);
          } else {
            return +damageString;
          }
        }

        const yScale = d3.scaleLinear()
          .domain([d3.min(filteredData, d => d['DMG'] - 5), d3.max(filteredData, d => d['DMG'] + 5)])
          .range([height, 0]);

        const xScale = d3.scaleLinear()
          .domain([d3.min(filteredData, d => d['Penetration Power'] - 5), d3.max(filteredData, d => d['Penetration Power'] + 5)])
          .range([0, width]);

        const xAxis = d3.axisBottom(xScale);
        const yAxis = d3.axisLeft(yScale);

        svg.append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(xAxis);

        svg.append("g")
          .call(yAxis);

        svg.selectAll("circle")
          .data(filteredData)
          .enter()
          .append("circle")
          .attr("cx", d => xScale(d['Penetration Power']))
          .attr("cy", d => yScale(d['DMG']))
          .attr("r", 5)
          .style("fill", "steelblue");

        svg.selectAll(".label")
          .data(filteredData)
          .enter()
          .append("text")
          .attr("class", "label")
          .attr("x", d => xScale(d['Penetration Power']))
          .attr("y", d => yScale(d['DMG']) - 10)
          .text(d => d['Name'])
          .attr("text-anchor", "middle")
          .attr("font-size", "10px")
          .attr("fill", "black")
          .style("pointer-events", "none");
              });

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height + margin.top + 20)
        .style("text-anchor", "middle")
        .text("Penetration");

      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y",-margin.left+10)
        .style("text-anchor", "middle")
        .text("Damage");
    }
    generateChart()
</script>
</body>
</html>